<p>Source page: <select id="source-page-widget"></select></p>
<p>Component name: <input id="search-component-widget" type="search" placeholder="I'm looking for a..."></p>
<ul id="component-results-outlet"><ul/>
<script>
  window.onmessage = ({data}) => {
    // Focus the search input as soon as the plugin fires
    ((searchComponentWidget) => {
      if (!!searchComponentWidget) searchComponentWidget.focus();
    })(document.getElementById('search-component-widget'));

    switch (data.pluginMessage.type) {
      case 'retrieved-current-source':
        // If the user has previous selected a source page, it will retrieve it
        // from the clientStorage and select it in the dropdown. 
        document.getElementById('source-page-widget').value = data.pluginMessage.source;
        break;
    
      default:
        break;
    }

    if (data.pluginMessage.type === 'pages') {
      const { pages } = data.pluginMessage;
      const source = document.getElementById('source-page-widget');
      pages.forEach(page => {
        const option = document.createElement('option');
        option.value = page.title;
        option.textContent = page.title;
        source.appendChild(option);
      }); 
    }
    if (data.pluginMessage.type === 'results') {
      const resultsEl = document.getElementById('component-results-outlet');
      const results = data.pluginMessage.results;
      resultsEl.innerHTML = ''; 
      const fragment = new DocumentFragment()

      results.map((result, index) => {
        const li = document.createElement('li');
        li.textContent = result
        li.classList.add('result');
        li.style.cursor = "pointer";
        if (index === 0) {
          li.classList.add('selected');
          li.style.backgroundColor= "gray";
        }
        fragment.appendChild(li);
      })

      resultsEl.appendChild(fragment);
    }
  }
  const getQuery = () => {
    const searchBox = document.getElementById('search-component-widget');
    const componentName = searchBox.value;

    return componentName;
  }
  const getSource = () => {
    const source = document.getElementById('source-page-widget');
    const sourceId = source.value;

    return sourceId;
  }

  parent.postMessage({ pluginMessage: { type: 'fetch-pages'} }, '*')
  parent.postMessage({ pluginMessage: { type: 'get-current-source'} }, '*')

  document.body.addEventListener("click", function (event) {
    if (event.target.classList.contains("result")) {
      parent.postMessage({ pluginMessage: { type: 'insert-component', componentName: event.target.textContent, source: getSource()} }, '*')
    }
  });

  document.body.addEventListener("keydown", function (event) {
    const results = document.querySelectorAll('.result');
    if (results.length > 0) {
      if (event.key === 'ArrowDown') {
        const selected = document.querySelector('.selected');
        if (selected) {
          selected.classList.remove('selected');
          selected.style.backgroundColor = 'transparent';
          const next = selected.nextElementSibling;
          if (next) {
            next.classList.add('selected');
            next.style.backgroundColor= "gray";
          } else {
            results[0].classList.add('selected');
            results[0].style.backgroundColor= "gray";
          }
      }
    } else if (event.key === 'ArrowUp') {
        const selected = document.querySelector('.selected');
        if (selected) {
          selected.classList.remove('selected');
          selected.style.backgroundColor = 'transparent';
          const prev = selected.previousElementSibling;
          if (prev) {
            prev.classList.add('selected');
            prev.style.backgroundColor= "gray";
          } else {
            results[results.length - 1].classList.add('selected');
            results[results.length - 1].style.backgroundColor= "gray";
          }
      }
    } else if (event.key === 'Enter') {
      const selected = document.querySelector('.selected');
      if (selected) {
        parent.postMessage({ pluginMessage: { type: 'insert-component', componentName: selected.textContent, source: getSource()} }, '*')
      }
    } 
   }
  if (event.key === 'Escape') {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
  }
  });

  document.body.addEventListener("mouseover", function (event) {
    if (event.target.classList.contains("result")) {
      Array.from(document.querySelectorAll('.result')).map(result => {
        result.classList.remove('selected');
        result.style.backgroundColor = 'transparent';
      });
      event.target.style.backgroundColor = "gray";
      event.target.classList.add('selected');
    }
  });

  document.getElementById('search-component-widget').oninput = () => {
    parent.postMessage({ pluginMessage: { type: 'fetch-results', componentName: getQuery(), source: getSource()} }, '*')
  }
  document.getElementById('source-page-widget').onchange = (event) => {
    parent.postMessage({ pluginMessage: { type: 'update-source', source: event.target.value } }, '*')
  }
</script>