<div>
  <div
    style="display: flex; width: 100%; font-size: 16px; line-height: 1; border-bottom: 1px solid #4C2FFC">
    <input 
      id="search-component-widget" 
      type="search" 
      placeholder="I'm looking for a..."
      style="outline: none; width: 100%; height: 30px; border: 0; font-size: inherit; line-height: inherit;"
      >
    <div style="display:flex; align-items: center; font-size: inherit; line-height: inherit;"><span style="font-family: Arial, Helvetica, sans-serif;">from: </span> 
      <select
       style="min-width: 100px; width: 100%; height: 30px; border: 0; font-size: inherit; line-height: inherit;"
       id="source-page-widget"></select></div>
  </div>
  <ul 
  id="component-results-outlet"
  style="list-style: none; padding: 0; margin-top: 10px;"
  ><ul/>
</div>
<script>
  // value getters utils
  const getQuery = () => document.getElementById('search-component-widget').value;
  const getSource = () => document.getElementById('source-page-widget').value;

  // styling utils
  const applyListItemHoverStyles = (li) => {
    li.style.backgroundColor = '#4C2FFC';
    li.style.color= 'white';
    li.style.padding = '3px';
  }

  const applyListItemStyles = (li) => {
    li.style.backgroundColor = 'transparent';
    li.style.color= 'black';
    li.style.padding = '5px';
    li.style.borderRadius= '5px';
    li.style.cursor = "pointer";
    li.style.fontSize = "inherit";
    li.style.lineHeight = "inherit";
    li.style.fontFamily = "Arial, Helvetica, sans-serif";
  }

  // Data to retrieve or actions to perform on the initial plugin load (e.g. available pages)  
  parent.postMessage({ pluginMessage: { type: 'fetch-pages'} }, '*')
  parent.postMessage({ pluginMessage: { type: 'get-current-source'} }, '*')

  window.onmessage = ({data}) => {
    // Focus the search input as soon as the plugin fires
    ((searchComponentWidget) => {
      if (!!searchComponentWidget) searchComponentWidget.focus();
    })(document.getElementById('search-component-widget'));

    switch (data.pluginMessage.type) {
      // If the user has previous selected a source page, it will retrieve it
      // from the clientStorage and select it in the dropdown. 
      case 'retrieved-current-source':
          document.getElementById('source-page-widget').value = data.pluginMessage.source;
          break;

        // Build the available pagas dropdown
        // This will serve as the source in which the user will search for the component
        case 'pages':
          ((source) => {
            if (!!source) {
              const { pages } = data.pluginMessage;
              pages.forEach(page => {
                const option = document.createElement('option');
                option.value = page.title;
                option.textContent = page.title;
                source.appendChild(option);
              }); 
            }
          })(document.getElementById('source-page-widget'))
          break;

        case 'results':
          ((outlet) => {
          // clear the list's contents and prepare a new document fragment
            outlet.innerHTML = ''; 
            const fragment = new DocumentFragment()

            //retrieve the results from the plugin message
            const { results }= data.pluginMessage;

            results.map((result, index) => {
              const li = document.createElement('li');
              li.textContent = result
              li.classList.add('result');
              applyListItemStyles(li);

              // Always make the first result, the selected one
              if (index === 0) {
                li.classList.add('selected');
                applyListItemHoverStyles(li);
              }
              fragment.appendChild(li);
            })

            outlet.appendChild(fragment);
          })(document.getElementById('component-results-outlet'));
          break;

      default:
        break;
    }
  }

  document.body.addEventListener("click", function (event) {
    if (event.target.classList.contains("result")) {
      parent.postMessage({ pluginMessage: { type: 'insert-component', componentName: event.target.textContent, source: getSource()} }, '*')
    }
  });

  document.body.addEventListener("keydown", function (event) {
    const results = document.querySelectorAll('.result');
    if (results.length > 0) {
      if (event.key === 'ArrowDown') {
        const selected = document.querySelector('.selected');
        if (selected) {
          selected.classList.remove('selected');
          applyListItemStyles(selected);
          const next = selected.nextElementSibling;
          if (next) {
            next.classList.add('selected');
            applyListItemHoverStyles(next);
          } else {
            results[0].classList.add('selected');
            applyListItemHoverStyles(results[0]);
          }
      }
    } else if (event.key === 'ArrowUp') {
        const selected = document.querySelector('.selected');
        if (selected) {
          selected.classList.remove('selected');
          applyListItemStyles(selected);
          const prev = selected.previousElementSibling;
          if (prev) {
            prev.classList.add('selected');
            applyListItemHoverStyles(prev);
          } else {
            results[results.length - 1].classList.add('selected');
            applyListItemHoverStyles(results[results.length - 1]);
          }
      }
    } else if (event.key === 'Enter') {
      const selected = document.querySelector('.selected');
      if (selected) {
        parent.postMessage({ pluginMessage: { type: 'insert-component', componentName: selected.textContent, source: getSource()} }, '*')
      }
    } 
   }
  if (event.key === 'Escape') {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
  }
  });

  document.body.addEventListener("mouseover", function (event) {
    if (event.target.classList.contains("result")) {
      Array.from(document.querySelectorAll('.result')).map(result => {
        result.classList.remove('selected');
        applyListItemStyles(result);
      });
      event.target.classList.add('selected');
      applyListItemHoverStyles(event.target);
    }
  });

  document.getElementById('search-component-widget').oninput = () => {
    parent.postMessage({ pluginMessage: { type: 'fetch-results', componentName: getQuery(), source: getSource()} }, '*')
  }
  document.getElementById('source-page-widget').onchange = (event) => {
    parent.postMessage({ pluginMessage: { type: 'update-source', source: event.target.value } }, '*')
  }

</script>