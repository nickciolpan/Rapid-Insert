<select id="source"></select>
<p>Component: <input id="search" type="text" placeholder="I'm looking for a..."></p>
<ul id="results"><ul/>
<button id="insert">Insert</button>
<button id="cancel">Cancel</button>
<script>
  /**
   * TODO: 
   * 1. Check why insert and cancel buttons dissapear after autocomplete
   * 2. On enter, take the currentlys elected item - the first result is always selected
   * 3. Make an item visible before clone - maybe add a setting
   * 4. choose to display only the first with the same name - see if theres any other way to differntiate
   * 5. Allow to choose search level (instance, component, type etc.)
   */

  window.onmessage = ({data}) => {
    if (data.pluginMessage.type === 'pages') {
      const { pages } = data.pluginMessage;
      const source = document.getElementById('source');
      pages.forEach(page => {
        const option = document.createElement('option');
        option.value = page.id;
        option.textContent = page.title;
        source.appendChild(option);
      }); 
    }
    if (data.pluginMessage.type=== 'results') {
      const resultsEl = document.getElementById('results');
      const results = data.pluginMessage.results;
      resultsEl.innerHTML = ''; 
      const fragment = new DocumentFragment()

      results.map(result => {
        const li = document.createElement('li');
        li.textContent = result
        li.classList.add('result');
        fragment.appendChild(li);
      })

      resultsEl.appendChild(fragment);
    }
  }
  const getQuery = () => {
    const searchBox = document.getElementById('search');
    const componentName = searchBox.value;

    return componentName;
  }
  const getSource = () => {
    const source = document.getElementById('source');
    const sourceId = source.value;

    return sourceId;
  }

  parent.postMessage({ pluginMessage: { type: 'fetch-pages'} }, '*')

  document.body.addEventListener("click", function (event) {
    if (event.target.classList.contains("result")) {
      parent.postMessage({ pluginMessage: { type: 'insert-component', componentName: event.target.textContent, source: getSource()} }, '*')
    }
  });

  document.getElementById('search').oninput = () => {
    parent.postMessage({ pluginMessage: { type: 'fetch-results', componentName: getQuery(), source: getSource()} }, '*')
  }

  document.getElementById('insert').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'insert-component', componentName: getQuery(), source: getSource()} }, '*')
  }

  document.getElementById('cancel').onclick = () => {
    parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
  }
</script>
